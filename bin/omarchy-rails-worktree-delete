#!/usr/bin/env bash
#
# omarchy-rails-worktree-delete: Delete a worktree and its associated zellij session
# Usage: omarchy-rails-worktree-delete <branch>
#

set -euo pipefail

# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# shellcheck source=lib/common.sh
source "${LIB_DIR}/common.sh"
# shellcheck source=lib/validation.sh
source "${LIB_DIR}/validation.sh"

# Check dependencies
check_dependencies gum git

# Ensure we're in a git repository
require_git_repository

# Get branch name
if [[ -z "${1:-}" ]]; then
  die "Branch name required"
fi

BRANCH_NAME="$1"

# Validate branch name
validate_branch_name "$BRANCH_NAME"

# Get worktree directory from git
ACTUAL_WORKTREE_DIR=$(get_worktree_dir "$BRANCH_NAME")

if [[ -z "$ACTUAL_WORKTREE_DIR" ]]; then
  die "Branch '$BRANCH_NAME' is not a valid worktree"
fi

# Validate worktree directory (must be in trees/)
validate_worktree_directory "$ACTUAL_WORKTREE_DIR"

# Show confirmation prompt
warn "You are about to delete:"
echo -e "  Branch: \e[1m$BRANCH_NAME\e[0m"
echo -e "  Path: \e[1m$ACTUAL_WORKTREE_DIR\e[0m"
echo ""

if ! gum confirm "Delete this worktree?"; then
  info "Cancelled"
  exit 0
fi

# Get session name (using APP_NAME from parent environment)
if [[ -z "${APP_NAME:-}" ]]; then
  # Fallback: derive from current directory
  APP_NAME=$(basename "$(git rev-parse --show-toplevel 2>/dev/null || pwd)")
fi

SESSION_NAME=$(get_session_name "$APP_NAME" "$BRANCH_NAME")

# Clean up zellij session
echo ""
info "ðŸ§¹ Cleaning up zellij session..."

kill_zellij_session "$SESSION_NAME"

# Remove git worktree
echo ""
info "ðŸŒ³ Removing git worktree..."

if git worktree remove "$ACTUAL_WORKTREE_DIR" --force 2>&1; then
  info "âœ“ Worktree deleted successfully"
  notify-send "Worktree deleted" "Branch: $BRANCH_NAME" 2>/dev/null || true
  exit 0
fi

# Fallback: try prune and manual removal
warn "Git worktree remove failed, trying manual cleanup..."

git worktree prune 2>/dev/null || true

if [[ -d "$ACTUAL_WORKTREE_DIR" ]]; then
  rm -rf "$ACTUAL_WORKTREE_DIR" 2>/dev/null || true

  if [[ ! -d "$ACTUAL_WORKTREE_DIR" ]]; then
    info "âœ“ Worktree deleted (manual cleanup)"
    notify-send "Worktree deleted" "Branch: $BRANCH_NAME (manual cleanup)" 2>/dev/null || true
    exit 0
  fi
fi

die "Failed to delete worktree: $ACTUAL_WORKTREE_DIR"
