#!/usr/bin/env bash
#
# omarchy-rails-worktree: Main menu interface for managing Rails worktrees
#

set -euo pipefail

# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# shellcheck source=lib/common.sh
source "${LIB_DIR}/common.sh"

# Check dependencies
check_dependencies omarchy-launch-walker omarchy-launch-floating-terminal-with-presentation omarchy-launch-terminal git

# Export zellij layout file
export ZELLIJ_LAYOUT_FILE
ZELLIJ_LAYOUT_FILE=$(realpath "${SCRIPT_DIR}/../share/zellij-layout.kdl")

# Set to true when going directly to a submenu, so we can exit directly
BACK_TO_EXIT=false

# UI helper functions
back_to() {
  local parent_menu="$1"

  if [[ "$BACK_TO_EXIT" == "true" ]]; then
    exit 0
  elif [[ -n "$parent_menu" ]]; then
    "$parent_menu"
  else
    show_main_menu
  fi
}

menu() {
  local prompt="$1"
  local options="$2"
  local extra="${3:-}"
  local preselect="${4:-}"

  local args=()
  if [[ -n "$extra" ]]; then
    read -r -a args <<<"$extra"
  fi

  if [[ -n "$preselect" ]]; then
    local index
    index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
    if [[ -n "$index" ]]; then
      args+=("-c" "$index")
    fi
  fi

  echo -e "$options" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 600 -p "$promptâ€¦" "${args[@]}" 2>/dev/null
}

terminal() {
  alacritty --class=Omarchy -e "$@"
}

present_terminal() {
  omarchy-launch-floating-terminal-with-presentation "$1"
}

open_in_editor() {
  notify-send "Editing config file" "$1"
  omarchy-launch-editor "$1"
}

# Menu functions
show_main_menu() {
  go_to_menu "$(menu "Rails Worktree" "Open project\nAdd project")"
}

go_to_menu() {
  case "${1,,}" in
  *open*) select_project_menu ;;
  *add*) omarchy-launch-floating-terminal-with-presentation "omarchy-rails-worktree-init" ;;
  esac
}

select_project_menu() {
  local projects
  projects=$(get_projects_list)

  if [[ -z "$projects" ]]; then
    notify-send "No projects" "No projects registered. Use 'Add project' first."
    back_to show_main_menu
    return
  fi

  local project_dir
  project_dir=$(menu "Open project" "$projects")

  if [[ "$project_dir" == "CNCLD" || -z "$project_dir" ]]; then
    back_to show_main_menu
  else
    cd "$project_dir" || die "Failed to change to project directory: $project_dir"
    export APP_NAME
    APP_NAME=$(basename "$project_dir")
    worktree_menu
  fi
}

worktree_menu() {
  local choice
  choice=$(menu "$(basename "$(pwd)")" "Open worktree\nAdd worktree\nDelete worktree")

  case "$choice" in
    *Open*) open_worktree_menu ;;
    *Add*) omarchy-launch-floating-terminal-with-presentation "${SCRIPT_DIR}/omarchy-rails-worktree-create" ;;
    *Delete*) delete_worktree_menu ;;
    *) back_to select_project_menu ;;
  esac
}

open_worktree_menu() {
  local worktree
  worktree=$(menu "Worktree branch" "$(worktree_list)")

  if [[ "$worktree" == "CNCLD" || -z "$worktree" ]]; then
    back_to worktree_menu
  elif [[ "$worktree" == "New worktree" ]]; then
    true
  else
    local worktree_dir
    worktree_dir=$(get_worktree_dir "$worktree")

    if [[ -z "$worktree_dir" ]]; then
      notify-send "Error" "Failed to find worktree directory for: $worktree"
      back_to worktree_menu
      return
    fi

    cd "$worktree_dir" || die "Failed to change to worktree directory: $worktree_dir"
    start_or_connect_session "$worktree"
  fi
}

delete_worktree_menu() {
  local worktree
  worktree=$(menu "Delete worktree" "$(worktree_list)")

  if [[ "$worktree" == "CNCLD" || -z "$worktree" ]]; then
    back_to worktree_menu
    return
  fi

  # Get worktree directory
  local worktree_dir
  worktree_dir=$(get_worktree_dir "$worktree")

  # Safety check: Only allow deletion of worktrees in trees/ directory
  if [[ "$worktree_dir" != *"/trees/"* ]]; then
    notify-send "Cannot delete worktree" "Only worktrees in trees/ directory can be deleted"
    back_to worktree_menu
    return
  fi

  # Launch deletion script in floating terminal with presentation
  omarchy-launch-floating-terminal-with-presentation "$SCRIPT_DIR/omarchy-rails-worktree-delete" "$worktree"
}

start_or_connect_session() {
  local branch="$1"
  local project_dir
  project_dir=$(pwd)
  local session_name
  session_name=$(get_session_name "$APP_NAME" "$branch")

  if session_is_alive "$session_name"; then
    # Session is alive, attach to it
    omarchy-launch-terminal -e bash -c "zellij attach \"$session_name\""
  elif session_exists "$session_name"; then
    # Session exists but is dead, recreate it
    zellij delete-session "$session_name" 2>/dev/null || true
    omarchy-launch-terminal -e bash -c "cd \"$project_dir\" && zellij --session \"$session_name\" --new-session-with-layout \"$ZELLIJ_LAYOUT_FILE\""
  else
    # Fresh start
    omarchy-launch-terminal -e bash -c "cd \"$project_dir\" && zellij --session \"$session_name\" --new-session-with-layout \"$ZELLIJ_LAYOUT_FILE\""
  fi
}

# Main entry point
if [[ -n "${1:-}" ]]; then
  BACK_TO_EXIT=true
  go_to_menu "$1"
else
  show_main_menu
fi
