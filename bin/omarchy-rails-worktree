#!/bin/bash

# Set to true when going directly to a submenu, so we can exit directly
BACK_TO_EXIT=false

back_to() {
  local parent_menu="$1"

  if [[ "$BACK_TO_EXIT" == "true" ]]; then
    exit 0
  elif [[ -n "$parent_menu" ]]; then
    "$parent_menu"
  else
    show_main_menu
  fi
}

menu() {
  local prompt="$1"
  local options="$2"
  local extra="$3"
  local preselect="$4"

  read -r -a args <<<"$extra"

  if [[ -n "$preselect" ]]; then
    local index
    index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
    if [[ -n "$index" ]]; then
      args+=("-c" "$index")
    fi
  fi

  echo -e "$options" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 600 -p "$promptâ€¦" "${args[@]}" 2>/dev/null
}

terminal() {
  alacritty --class=Omarchy -e "$@"
}

present_terminal() {
  omarchy-launch-floating-terminal-with-presentation $1
}

open_in_editor() {
  notify-send "Editing config file" "$1"
  omarchy-launch-editor "$1"
}

## MAIN CODE 


show_main_menu() {
  go_to_menu "$(menu "Rails Worktree" "Open project\nAdd project")"
}

go_to_menu() {
  case "${1,,}" in
  *open*) select_project_menu ;;
  *add*) omarchy-launch-floating-terminal-with-presentation "omarchy-rails-worktree-init" ;;
  esac
}

select_project_menu() {
  project_dir=$(menu "Open project" "$(cat $HOME/.config/omarchy-rails-worktree/projects)")

  if [[ "$project_dir" == "CNCLD" || -z "$project_dir" ]]; then
    back_to show_main_menu
  else
    cd $project_dir
    export APP_NAME=$(basename "$project_dir")
    worktree_menu
  fi
}

worktree_list() {
  git worktree list --porcelain | grep -E "^branch" | sed 's/branch refs\/heads\///g'
}

get_worktree_dir() {
  local branch=$1
  git worktree list --porcelain | grep -B2 -E "^branch refs/heads/$branch" | head -n 1 | sed 's/^worktree //'
}

worktree_menu() {
  case $(menu "$(basename $(pwd))" "Open worktree\nAdd worktree\nDelete worktree") in
    *Open*) open_worktree_menu ;;
    *Add*) omarchy-launch-floating-terminal-with-presentation $SCRIPT_DIR/omarchy-rails-worktree-create ;;
    *Delete*) delete_worktree_menu ;;
    *) back_to select_project_menu ;;
  esac
}

open_worktree_menu() {
  worktree=$(menu "Worktree branch" "$(worktree_list)")
  if [[ "$worktree" == "CNCLD" || -z "$worktree" ]]; then
    back_to worktree_menu
  elif [[ "$worktree" == "New worktree" ]]; then
    true
  else
    cd $(get_worktree_dir $worktree)
    start_or_connect_session $worktree
  fi
}

delete_worktree_menu() {
  worktree=$(menu "Delete worktree" "$(worktree_list)")

  if [[ "$worktree" == "CNCLD" || -z "$worktree" ]]; then
    back_to worktree_menu
    return
  fi

  # Get worktree directory
  worktree_dir=$(get_worktree_dir "$worktree")

  # Safety check: Only allow deletion of worktrees in trees/ directory
  if [[ "$worktree_dir" != *"/trees/"* ]]; then
    notify-send "Cannot delete worktree" "Only worktrees in trees/ directory can be deleted"
    back_to worktree_menu
    return
  fi

  # Launch deletion script in floating terminal with presentation
  omarchy-launch-floating-terminal-with-presentation "$SCRIPT_DIR/omarchy-rails-worktree-delete" "$worktree"
}

start_or_connect_session() {
  BRANCH=$1
  PROJECT_DIR=$(pwd)
  session_name="$APP_NAME-$BRANCH" 

  zellij_session=$(zellij list-sessions -n | grep -E "^$session_name ")

  if [[ ! -z "$zellij_session" ]]; then
    # session exists, let's check if it's alive
    if [[ -z "$(echo "$zellij_session" | grep "EXITED")" ]]; then
      # session is alive, let's attach to it
      omarchy-launch-terminal -e bash -c "zellij attach $session_name"
    else
      # session is dead, let's recreate it
      zellij delete-session $session_name
      omarchy-launch-terminal -e bash -c "cd $PROJECT_DIR && zellij --session $session_name --new-session-with-layout $ZELLIJ_LAYOUT_FILE"
    fi
  else
    # Fresh start
    omarchy-launch-terminal -e bash -c "cd $PROJECT_DIR && zellij --session $session_name --new-session-with-layout $ZELLIJ_LAYOUT_FILE"
  fi
}


SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export ZELLIJ_LAYOUT_FILE=$(realpath "${SCRIPT_DIR}/../share/zellij-layout.kdl")

if [[ -n "$1" ]]; then
  BACK_TO_EXIT=true
  go_to_menu "$1"
else
  show_main_menu
fi
