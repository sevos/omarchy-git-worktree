#!/usr/bin/env bash
#
# omarchy-rails-worktree: Main menu interface for managing Rails worktrees
#

set -euo pipefail

# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# shellcheck source=lib/common.sh
source "${LIB_DIR}/common.sh"

# Check dependencies
check_dependencies omarchy-launch-walker omarchy-launch-floating-terminal-with-presentation omarchy-launch-terminal git

# Export zellij layout file
export ZELLIJ_LAYOUT_FILE
ZELLIJ_LAYOUT_FILE=$(realpath "${SCRIPT_DIR}/../share/zellij-layout.kdl")

# Set to true when going directly to a submenu, so we can exit directly
BACK_TO_EXIT=false

# UI helper functions
back_to() {
  local parent_menu="$1"

  if [[ "$BACK_TO_EXIT" == "true" ]]; then
    exit 0
  elif [[ -n "$parent_menu" ]]; then
    "$parent_menu"
  else
    show_main_menu
  fi
}

menu() {
  local prompt="$1"
  local options="$2"
  local extra="${3:-}"
  local preselect="${4:-}"

  local args=()
  if [[ -n "$extra" ]]; then
    read -r -a args <<<"$extra"
  fi

  if [[ -n "$preselect" ]]; then
    local index
    index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
    if [[ -n "$index" ]]; then
      args+=("-c" "$index")
    fi
  fi

  echo -e "$options" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 600 -p "$prompt…" "${args[@]}" 2>/dev/null
}

terminal() {
  alacritty --class=Omarchy -e "$@"
}

present_terminal() {
  omarchy-launch-floating-terminal-with-presentation "$1"
}

open_in_editor() {
  notify-send "Editing config file" "$1"
  omarchy-launch-editor "$1"
}

# Menu functions
show_main_menu() {
  local recent_items_full
  recent_items_full=$(generate_recent_items)

  local options=""

  # Add recent items section if available
  if [[ -n "$recent_items_full" ]]; then
    # Strip metadata (everything after first |) for display only
    local recent_items_display
    recent_items_display=$(echo -e "$recent_items_full" | sed 's/|.*$//')
    options="${recent_items_display}\n─────────────────────\n"
  fi

  # Add standard menu options
  options="${options}Browse all projects\nAdd worktree\nDelete worktree\nAdd project"

  local selection
  selection=$(menu "Rails Worktree" "$options")

  # Handle selection
  if [[ "$selection" == "CNCLD" || -z "$selection" ]]; then
    return 1  # Signal to exit
  elif [[ "$selection" =~ ^⚡ ]]; then
    # Recent item selected - need to find matching full line with metadata
    local matched_line
    matched_line=$(echo -e "$recent_items_full" | grep "^${selection}|")

    if [[ -n "$matched_line" ]]; then
      open_recent_worktree "$matched_line"
    else
      notify-send "Error" "Failed to find matching recent item"
      return 0  # Continue showing menu
    fi
  else
    # Standard menu navigation
    go_to_menu "$selection"
  fi
  return 0  # Continue showing menu
}

open_recent_worktree() {
  local selection="$1"

  # Parse the selection to extract project_dir and branch
  local parsed
  parsed=$(parse_recent_selection "$selection")

  local project_dir branch
  project_dir=$(echo "$parsed" | sed -n '1p')
  branch=$(echo "$parsed" | sed -n '2p')

  if [[ -z "$project_dir" ]] || [[ -z "$branch" ]]; then
    notify-send "Error" "Failed to parse recent selection"
    show_main_menu
    return
  fi

  # Verify project still exists
  if [[ ! -d "$project_dir" ]]; then
    notify-send "Error" "Project directory no longer exists: $project_dir"
    show_main_menu
    return
  fi

  # Set up environment
  cd "$project_dir" || die "Failed to change to project directory: $project_dir"
  export APP_NAME
  APP_NAME=$(basename "$project_dir")

  # Get worktree directory
  local worktree_dir
  worktree_dir=$(get_worktree_dir "$branch")

  if [[ -z "$worktree_dir" ]]; then
    notify-send "Error" "Worktree no longer exists: $branch"
    show_main_menu
    return
  fi

  # Change to worktree and start session
  cd "$worktree_dir" || die "Failed to change to worktree directory: $worktree_dir"
  start_or_connect_session "$branch"
  exit 0
}

go_to_menu() {
  case "${1,,}" in
  *browse*|*open*) select_project_menu ;;
  *add\ worktree*) add_worktree_menu ;;
  *delete\ worktree*) delete_worktree_unified_menu ;;
  *add\ project*) omarchy-launch-floating-terminal-with-presentation "omarchy-rails-worktree-init" ;;
  esac
}

add_worktree_menu() {
  local projects
  projects=$(get_projects_list)

  if [[ -z "$projects" ]]; then
    notify-send "No projects" "No projects registered. Use 'Add project' first."
    back_to show_main_menu
    return
  fi

  local project_dir
  project_dir=$(menu "Select project" "$projects")

  if [[ "$project_dir" == "CNCLD" || -z "$project_dir" ]]; then
    back_to show_main_menu
  else
    cd "$project_dir" || die "Failed to change to project directory: $project_dir"
    export APP_NAME
    APP_NAME=$(basename "$project_dir")
    omarchy-launch-floating-terminal-with-presentation "${SCRIPT_DIR}/omarchy-rails-worktree-create"
  fi
}

delete_worktree_unified_menu() {
  # Get all projects
  local projects
  projects=$(get_projects_list)

  if [[ -z "$projects" ]]; then
    notify-send "No projects" "No projects registered."
    back_to show_main_menu
    return
  fi

  # Build unified list of all worktrees across all projects
  local unified_list=""
  while IFS= read -r project_dir; do
    if [[ ! -d "$project_dir" ]]; then
      continue
    fi

    local project_name
    project_name=$(basename "$project_dir")

    # Get branches for this project
    cd "$project_dir" || continue
    local branches
    branches=$(worktree_list)

    if [[ -n "$branches" ]]; then
      while IFS= read -r branch; do
        # Format: "project › branch" with embedded metadata
        unified_list="${unified_list}${project_name} › ${branch}|${project_dir}|${branch}\n"
      done <<< "$branches"
    fi
  done <<< "$projects"

  if [[ -z "$unified_list" ]]; then
    notify-send "No worktrees" "No worktrees found in any project."
    back_to show_main_menu
    return
  fi

  # Show unified selection menu
  local selection
  selection=$(menu "Delete worktree" "$(echo -e "$unified_list" | sed 's/|.*$//')")

  if [[ "$selection" == "CNCLD" || -z "$selection" ]]; then
    back_to show_main_menu
    return
  fi

  # Parse selection to find the matching entry with metadata
  local matched_line
  matched_line=$(echo -e "$unified_list" | grep "^${selection}|")

  if [[ -z "$matched_line" ]]; then
    notify-send "Error" "Failed to parse selection"
    back_to show_main_menu
    return
  fi

  # Extract project_dir and branch
  local display project_dir branch
  IFS='|' read -r display project_dir branch <<< "$matched_line"

  # Set up environment
  cd "$project_dir" || die "Failed to change to project directory: $project_dir"
  export APP_NAME
  APP_NAME=$(basename "$project_dir")

  # Verify worktree directory
  local worktree_dir
  worktree_dir=$(get_worktree_dir "$branch")

  # Safety check
  if [[ "$worktree_dir" != *"/trees/"* ]]; then
    notify-send "Cannot delete worktree" "Only worktrees in trees/ directory can be deleted"
    back_to show_main_menu
    return
  fi

  # Launch deletion script
  omarchy-launch-floating-terminal-with-presentation "$SCRIPT_DIR/omarchy-rails-worktree-delete" "$branch"
}

select_project_menu() {
  local projects
  projects=$(get_projects_list)

  if [[ -z "$projects" ]]; then
    notify-send "No projects" "No projects registered. Use 'Add project' first."
    back_to show_main_menu
    return
  fi

  local project_dir
  project_dir=$(menu "Open project" "$projects")

  if [[ "$project_dir" == "CNCLD" || -z "$project_dir" ]]; then
    back_to show_main_menu
  else
    cd "$project_dir" || die "Failed to change to project directory: $project_dir"
    export APP_NAME
    APP_NAME=$(basename "$project_dir")
    worktree_menu
  fi
}

worktree_menu() {
  local choice
  choice=$(menu "$(basename "$(pwd)")" "Open worktree\nAdd worktree\nDelete worktree")

  case "$choice" in
    *Open*) open_worktree_menu ;;
    *Add*) omarchy-launch-floating-terminal-with-presentation "${SCRIPT_DIR}/omarchy-rails-worktree-create" ;;
    *Delete*) delete_worktree_menu ;;
    *) back_to select_project_menu ;;
  esac
}

open_worktree_menu() {
  local worktree
  worktree=$(menu "Worktree branch" "$(worktree_list)")

  if [[ "$worktree" == "CNCLD" || -z "$worktree" ]]; then
    back_to worktree_menu
  elif [[ "$worktree" == "New worktree" ]]; then
    true
  else
    local worktree_dir
    worktree_dir=$(get_worktree_dir "$worktree")

    if [[ -z "$worktree_dir" ]]; then
      notify-send "Error" "Failed to find worktree directory for: $worktree"
      back_to worktree_menu
      return
    fi

    cd "$worktree_dir" || die "Failed to change to worktree directory: $worktree_dir"
    start_or_connect_session "$worktree"
    exit 0
  fi
}

delete_worktree_menu() {
  local worktree
  worktree=$(menu "Delete worktree" "$(worktree_list)")

  if [[ "$worktree" == "CNCLD" || -z "$worktree" ]]; then
    back_to worktree_menu
    return
  fi

  # Get worktree directory
  local worktree_dir
  worktree_dir=$(get_worktree_dir "$worktree")

  # Safety check: Only allow deletion of worktrees in trees/ directory
  if [[ "$worktree_dir" != *"/trees/"* ]]; then
    notify-send "Cannot delete worktree" "Only worktrees in trees/ directory can be deleted"
    back_to worktree_menu
    return
  fi

  # Launch deletion script in floating terminal with presentation
  omarchy-launch-floating-terminal-with-presentation "$SCRIPT_DIR/omarchy-rails-worktree-delete" "$worktree"
}

start_or_connect_session() {
  local branch="$1"
  local project_dir
  project_dir=$(pwd)
  local session_name
  session_name=$(get_session_name "$APP_NAME" "$branch")

  # Find the main project directory (go up from worktree dir if needed)
  local main_project_dir="$project_dir"
  if [[ "$project_dir" == *"/trees/"* ]]; then
    # We're in a worktree, find the main project directory
    main_project_dir=$(echo "$project_dir" | sed 's|/trees/.*||')
  fi

  # Record this worktree access
  record_worktree_access "$main_project_dir" "$branch"

  if session_is_alive "$session_name"; then
    # Session is alive, attach to it
    omarchy-launch-terminal -e bash -c "zellij attach \"$session_name\""
  elif session_exists "$session_name"; then
    # Session exists but is dead, recreate it
    zellij delete-session "$session_name" 2>/dev/null || true
    omarchy-launch-terminal -e bash -c "cd \"$project_dir\" && zellij --session \"$session_name\" --new-session-with-layout \"$ZELLIJ_LAYOUT_FILE\""
  else
    # Fresh start
    omarchy-launch-terminal -e bash -c "cd \"$project_dir\" && zellij --session \"$session_name\" --new-session-with-layout \"$ZELLIJ_LAYOUT_FILE\""
  fi
}

# Main entry point
if [[ -n "${1:-}" ]]; then
  BACK_TO_EXIT=true
  go_to_menu "$1"
else
  # Keep showing main menu until user presses ESC
  while show_main_menu; do
    :  # Continue loop
  done
fi
