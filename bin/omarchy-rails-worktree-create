#!/usr/bin/env bash
#
# omarchy-rails-worktree-create: Create a new worktree in the current Rails project
# Usage: omarchy-rails-worktree-create <branch>
#

set -euo pipefail

# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# shellcheck source=lib/common.sh
source "${LIB_DIR}/common.sh"
# shellcheck source=lib/validation.sh
source "${LIB_DIR}/validation.sh"

# Check dependencies
check_dependencies gum git

# Ensure we're in a git repository
require_git_repository

# Cleanup function for port locks
PORT_OFFSET=""
cleanup() {
  if [[ -n "${PORT_OFFSET}" ]]; then
    release_port_lock "$PORT_OFFSET"
  fi
}
trap cleanup EXIT INT TERM

# Clean up stale locks before starting
cleanup_stale_locks

# Get branch name from argument or prompt
if [[ -z "${1:-}" ]]; then
  echo -e "\e[32mProvide a new or existing branch name\n\e[0m"
  BRANCH_NAME=$(gum input --placeholder="Branch name" --header="") || exit 1
else
  BRANCH_NAME="$1"
fi

if [[ -z "$BRANCH_NAME" ]]; then
  die "Branch name cannot be empty"
fi

# Validate branch name
validate_branch_name "$BRANCH_NAME"

# Check if worktree already exists
if worktree_exists "$BRANCH_NAME"; then
  die "Worktree for branch '$BRANCH_NAME' already exists!"
fi

# Set up directories
WORKTREE_BASE_DIR="$(pwd)/trees"
WORKTREE_DIR="${WORKTREE_BASE_DIR}/${BRANCH_NAME}"

# Validate that worktree directory doesn't already exist
if [[ -e "$WORKTREE_DIR" ]]; then
  die "Directory already exists: $WORKTREE_DIR"
fi

# Allocate port with safe locking mechanism
info "ðŸ”¢ Allocating port..."
PORT_OFFSET=$(safe_port_allocation "$WORKTREE_BASE_DIR")
SERVER_PORT=$((SERVER_BASE_PORT + PORT_OFFSET * 10))

info "Allocated port: $SERVER_PORT (offset: $PORT_OFFSET)"

# Create git worktree
info "ðŸŒ³ Creating git worktree..."
if git worktree add "$WORKTREE_DIR" "$BRANCH_NAME" 2>/dev/null; then
  info "Using existing branch: $BRANCH_NAME"
else
  # If branch doesn't exist, create it from HEAD
  info "Creating new branch: $BRANCH_NAME"
  git worktree add "$WORKTREE_DIR" -b "$BRANCH_NAME" || die "Failed to create worktree"
fi

# Verify worktree was created
if ! git worktree list | grep -qF "$WORKTREE_DIR"; then
  die "Failed to create worktree"
fi

# Setup environment files
info "ðŸ“„ Setting up environment files..."
if [[ -f ".env" ]]; then
  cp ".env" "$WORKTREE_DIR/.env"
  info "Copied .env file"
elif [[ -f ".env.sample" ]]; then
  cp ".env.sample" "$WORKTREE_DIR/.env"
  warn "Copied .env.sample - you may need to configure API keys"
else
  warn "No .env or .env.sample found - creating minimal .env"
  touch "$WORKTREE_DIR/.env"
fi

# Add port to .env
echo "PORT=${SERVER_PORT}" >> "$WORKTREE_DIR/.env"

# Link shared resources
info "ðŸ”— Linking shared resources..."

link_shared_resource \
  "config/master.key" \
  "$WORKTREE_DIR/config/master.key" \
  "master.key"

link_shared_resource \
  ".claude/settings.local.json" \
  "$WORKTREE_DIR/.claude/settings.local.json" \
  "Claude settings"

# Install dependencies and setup
info "ðŸ“¦ Installing dependencies..."
cd "$WORKTREE_DIR" || die "Failed to cd to worktree directory"

if [[ ! -f "bin/setup" ]]; then
  die "bin/setup not found in worktree"
fi

# Run setup (allow it to fail without exiting)
if bin/setup --skip-server 2>&1; then
  info "âœ“ Setup completed successfully"
else
  warn "Setup completed with warnings"
fi

# Run validation if bin/ci exists
if [[ -f "bin/ci" ]]; then
  info "ðŸ” Running validation..."
  if bin/ci 2>&1; then
    info "âœ“ Validation passed"
  else
    warn "Validation failed - please review before using this worktree"
  fi
fi

info ""
info "âœ“ Worktree created successfully!"
info "  Branch: $BRANCH_NAME"
info "  Path: $WORKTREE_DIR"
info "  Port: $SERVER_PORT"
