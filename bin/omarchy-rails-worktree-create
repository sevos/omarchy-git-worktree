#!/bin/bash

worktree_list() {
  git worktree list --porcelain | grep branch | sed 's/branch refs\/heads\///g'
}

# omarchy-rails-worktree-create: Create a new worktree in the current Rails project
# Usage: omarchy-rails-worktree-create <branch>

if [ -z "$1" ]; then
  echo -e "\e[32mProvide a new or existing branch name\n\e[0m"
  BRANCH_NAME=$(gum input --placeholder="Branch name" --header="")
else
  BRANCH_NAME="$1"
fi


if [ -z "$BRANCH_NAME" ]; then
  exit 1
fi

WORKTREE_BASE_DIR=$(pwd)/trees

if [[ ! -z "$(worktree_list | grep -E "^$BRANCH_NAME$")" ]]; then
  echo -e "Worktree for this branch already exists!"
  exit 1
fi

# Calculate port offset if not provided
if [ -z "$PORT_OFFSET" ]; then
  # Collect all currently used port offsets
  declare -a USED_OFFSETS

  if [ -d "$WORKTREE_BASE_DIR" ]; then
    # Get all worktrees and their ports
    while IFS= read -r worktree_dir; do
      if [ -f "$worktree_dir/.env" ]; then
        PORT=$(grep "^PORT=" "$worktree_dir/.env" 2>/dev/null | cut -d= -f2)
        if [ -n "$PORT" ]; then
          # Calculate offset from port (PORT = 3000 + OFFSET * 10)
          OFFSET=$(((PORT - SERVER_BASE_PORT) / 10))
          USED_OFFSETS+=("$OFFSET")
        fi
      fi
    done < <(find "$WORKTREE_BASE_DIR" -mindepth 1 -maxdepth 2 -type d)
  fi

  # Find smallest available offset starting from 1
  PORT_OFFSET=1
  while true; do
    # Check if this offset is already used
    OFFSET_IN_USE=false
    for used_offset in "${USED_OFFSETS[@]}"; do
      if [ "$used_offset" = "$PORT_OFFSET" ]; then
        OFFSET_IN_USE=true
        break
      fi
    done

    # If not in use, we found our offset
    if [ "$OFFSET_IN_USE" = false ]; then
      break
    fi

    PORT_OFFSET=$((PORT_OFFSET + 1))
  done
fi

# Calculate ports
SERVER_BASE_PORT=3000
SERVER_PORT=$((SERVER_BASE_PORT + PORT_OFFSET * 10))
WORKTREE_DIR="$WORKTREE_BASE_DIR/$BRANCH_NAME"

echo "üå≥ Creating git worktree..."
git worktree add "$WORKTREE_DIR" "$BRANCH_NAME" 2>/dev/null || {
  # If branch doesn't exist, create it from HEAD
  git worktree add "$WORKTREE_DIR" -b "$BRANCH_NAME"
}

if ! git worktree list | grep -q "$WORKTREE_DIR"; then
  echo "Error: Failed to create worktree"
  exit 1
fi

echo "üìÑ Setting up environment files..."
if [ -f ".env" ]; then
  cp ".env" "$WORKTREE_DIR/.env"
elif [ -f ".env.sample" ]; then
  cp ".env.sample" "$WORKTREE_DIR/.env"
  echo "‚ö†Ô∏è  Warning: Copied .env.sample - you may need to configure API keys"
fi

# Link master.key
echo "üîë Linking master.key..."
if [ -f "config/master.key" ]; then
  MASTER_KEY_PATH="$(realpath config/master.key)"
  ln -sf "$MASTER_KEY_PATH" "$WORKTREE_DIR/config/master.key"
else
  echo "‚ö†Ô∏è  Warning: config/master.key not found - Rails credentials won't work"
fi

# Link Claude settings
echo "üîó Linking Claude settings..."
if [ -f ".claude/settings.local.json" ]; then
  mkdir -p "$WORKTREE_DIR/.claude"
  CLAUDE_SETTINGS_PATH="$(realpath .claude/settings.local.json)"
  ln -sf "$CLAUDE_SETTINGS_PATH" "$WORKTREE_DIR/.claude/settings.local.json"
else
  echo "‚ÑπÔ∏è  Info: .claude/settings.local.json not found - skipping"
fi

# Setup server environment
echo "PORT=$SERVER_PORT" >> "$WORKTREE_DIR/.env"

echo "üì¶ Installing dependencies..."
cd "$WORKTREE_DIR"

if [ ! -f "bin/setup" ]; then
  echo "Error: bin/setup not found in worktree"
  exit 1
fi

bin/setup --skip-server
if [ -f "bin/ci" ]; then
  echo "üîç Running validation..."
  bin/ci
fi
