#!/usr/bin/env bash
#
# omarchy-rails-worktree-create: Create a new worktree in the current Rails project
# Usage: omarchy-rails-worktree-create <branch>
#

set -euo pipefail

# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# shellcheck source=lib/common.sh
source "${LIB_DIR}/common.sh"
# shellcheck source=lib/validation.sh
source "${LIB_DIR}/validation.sh"

# Check dependencies
check_dependencies gum git

# Ensure we're in a git repository
require_git_repository

# Get branch name from argument or prompt
if [[ -z "${1:-}" ]]; then
  echo -e "\e[32mProvide a new or existing branch name\n\e[0m"
  BRANCH_NAME=$(gum input --placeholder="Branch name" --header="") || exit 1
else
  BRANCH_NAME="$1"
fi

if [[ -z "$BRANCH_NAME" ]]; then
  die "Branch name cannot be empty"
fi

# Validate branch name
validate_branch_name "$BRANCH_NAME"

# Check if worktree already exists
if worktree_exists "$BRANCH_NAME"; then
  die "Worktree for branch '$BRANCH_NAME' already exists!"
fi

# Set up directories
PROJECT_DIR="$(pwd)"
WORKTREE_BASE_DIR="${PROJECT_DIR}/trees"
WORKTREE_DIR="${WORKTREE_BASE_DIR}/${BRANCH_NAME}"

# Validate that worktree directory doesn't already exist
if [[ -e "$WORKTREE_DIR" ]]; then
  die "Directory already exists: $WORKTREE_DIR"
fi

# Create git worktree
info "ðŸŒ³ Creating git worktree..."
if git worktree add "$WORKTREE_DIR" "$BRANCH_NAME" 2>/dev/null; then
  info "Using existing branch: $BRANCH_NAME"
else
  # If branch doesn't exist, create it from HEAD
  info "Creating new branch: $BRANCH_NAME"
  git worktree add "$WORKTREE_DIR" -b "$BRANCH_NAME" || die "Failed to create worktree"
fi

# Verify worktree was created
if ! git worktree list | grep -qF "$WORKTREE_DIR"; then
  die "Failed to create worktree"
fi

# Run module-specific setup scripts
info "ðŸ”§ Running setup modules..."
MODULES_DIR="${SCRIPT_DIR}/../modules"
if [[ -d "$MODULES_DIR" ]]; then
  for module_setup in "$MODULES_DIR"/*/setup; do
    if [[ -x "$module_setup" ]]; then
      "$module_setup" "$WORKTREE_DIR" "$BRANCH_NAME" "$PROJECT_DIR"
    fi
  done
fi

info ""
info "âœ“ Worktree created successfully!"
info "  Branch: $BRANCH_NAME"
info "  Path: $WORKTREE_DIR"

# Record this worktree in recent access list
record_worktree_access "$PROJECT_DIR" "$BRANCH_NAME"
