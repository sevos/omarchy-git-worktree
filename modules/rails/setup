#!/usr/bin/env bash
#
# Rails-specific setup for omarchy-rails-worktree
# This module detects Rails projects and performs Rails-specific setup tasks.
# Exits silently (status 0) if not a Rails project.
#

set -euo pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common utilities from main lib
COMMON_LIB="$SCRIPT_DIR/../../lib/common.sh"
if [[ ! -f "$COMMON_LIB" ]]; then
  echo "Error: Cannot find common.sh" >&2
  exit 1
fi
source "$COMMON_LIB"

# Source Rails-specific utilities
source "$SCRIPT_DIR/lib/rails.sh"

# Parse arguments
WORKTREE_DIR="${1:-}"
BRANCH_NAME="${2:-}"
MAIN_REPO_DIR="${3:-}"

if [[ -z "$WORKTREE_DIR" || -z "$BRANCH_NAME" || -z "$MAIN_REPO_DIR" ]]; then
  die "Usage: $0 <worktree_dir> <branch_name> <main_repo_dir>"
fi

# Detect if this is a Rails project
# Check for Gemfile, config/application.rb, and app/ directory
is_rails_project() {
  [[ -f "$MAIN_REPO_DIR/Gemfile" ]] && \
  [[ -f "$MAIN_REPO_DIR/config/application.rb" ]] && \
  [[ -d "$MAIN_REPO_DIR/app" ]]
}

# Exit silently if not a Rails project
if ! is_rails_project; then
  exit 0
fi

info "ðŸš‚ Detected Rails project - running Rails-specific setup..."

# Cleanup stale port locks before starting
cleanup_stale_locks

# Allocate port with cleanup on exit
OFFSET=""
cleanup_port() {
  if [[ -n "$OFFSET" ]]; then
    release_port_lock "$OFFSET"
  fi
}
trap cleanup_port EXIT INT TERM

# Allocate port
WORKTREE_BASE_DIR=$(dirname "$WORKTREE_DIR")
OFFSET=$(safe_port_allocation "$WORKTREE_BASE_DIR")
SERVER_PORT=$((SERVER_BASE_PORT + (OFFSET * 10)))

# Setup environment files
info "ðŸ“„ Setting up environment files..."
cd "$MAIN_REPO_DIR" || die "Failed to cd to main repo directory"

if [[ -f ".env" ]]; then
  cp ".env" "$WORKTREE_DIR/.env"
  info "Copied .env file"
elif [[ -f ".env.sample" ]]; then
  cp ".env.sample" "$WORKTREE_DIR/.env"
  warn "Copied .env.sample - you may need to configure API keys"
else
  warn "No .env or .env.sample found - creating minimal .env"
  touch "$WORKTREE_DIR/.env"
fi

# Add port to .env
echo "PORT=${SERVER_PORT}" >> "$WORKTREE_DIR/.env"
info "Allocated port: $SERVER_PORT"

# Link shared resources
info "ðŸ”— Linking shared resources..."

link_shared_resource \
  "$MAIN_REPO_DIR/config/master.key" \
  "$WORKTREE_DIR/config/master.key" \
  "master.key"

# Install dependencies and setup
info "ðŸ“¦ Installing dependencies..."
cd "$WORKTREE_DIR" || die "Failed to cd to worktree directory"

if [[ ! -f "bin/setup" ]]; then
  warn "bin/setup not found in worktree - skipping Rails setup"
  exit 0
fi

# Run setup (allow it to fail without exiting)
if bin/setup --skip-server 2>&1; then
  info "âœ“ Setup completed successfully"
else
  warn "Setup completed with warnings"
fi

# Run validation if bin/ci exists
if [[ -f "bin/ci" ]]; then
  info "ðŸ” Running validation..."
  if bin/ci 2>&1; then
    info "âœ“ Validation passed"
  else
    warn "Validation failed - please review before using this worktree"
  fi
fi

info "âœ“ Rails setup completed"
info "  Port: $SERVER_PORT"
