#!/usr/bin/env bash
#
# Claude-specific setup for omarchy-rails-worktree
# This module detects Claude configuration and symlinks it to the worktree.
# Exits silently (status 0) if Claude config is not found.
#

set -euo pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common utilities from main lib
COMMON_LIB="$SCRIPT_DIR/../../lib/common.sh"
if [[ ! -f "$COMMON_LIB" ]]; then
  echo "Error: Cannot find common.sh" >&2
  exit 1
fi
source "$COMMON_LIB"

# Parse arguments
WORKTREE_DIR="${1:-}"
BRANCH_NAME="${2:-}"
MAIN_REPO_DIR="${3:-}"

if [[ -z "$WORKTREE_DIR" || -z "$BRANCH_NAME" || -z "$MAIN_REPO_DIR" ]]; then
  die "Usage: $0 <worktree_dir> <branch_name> <main_repo_dir>"
fi

# Check if Claude config exists in main repo
CLAUDE_CONFIG="$MAIN_REPO_DIR/.claude/settings.local.json"

if [[ ! -f "$CLAUDE_CONFIG" ]]; then
  # Claude config not found - exit silently
  exit 0
fi

info "ðŸ¤– Detected Claude configuration - linking to worktree..."

# Link Claude settings
link_shared_resource \
  "$CLAUDE_CONFIG" \
  "$WORKTREE_DIR/.claude/settings.local.json" \
  "Claude settings"

info "âœ“ Claude setup completed"
